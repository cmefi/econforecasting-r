# Set Constants
```{r}
DIR = 'D:/Onedrive/__Projects/econforecasting'
PACKAGE_DIR = 'D:/Onedrive/__Projects/econforecasting/r-package' # Path to package with helper functions
DOC_DIR = 'D:/Onedrive/__Projects/econforecasting/documentation-templates' # Path to documentation .RNW file; if NULL no docs generated
INPUT_DIR = 'D:/Onedrive/__Projects/econforecasting/model-inputs' # Path to directory with inputs.r, constants.r (SQL DB info, SFTP info, etc.)
OUTPUT_DIR = 'D:/Onedrive/__Projects/econforecasting/model-outputs' # Path to location to output RDS and documentation
```

# Initialize
```{r}
library(tidyverse)
library(devtools)
library(lubridate)
library(knitr)
library(foreach)
library(doParallel) # Parallelized backtests
```

# Some Metaprogramming to Convert RMD to an R Function
```{r}
local({
	# Use purl to extract main R code (minus first chunk) from Rmd and convert it to a function
	if (file.exists(file.path(DIR, 'model-nowcasts.r'))) file.remove(file.path(DIR, 'model-nowcasts.r'))
	knitr::purl(input = file.path(DIR, 'model-nowcasts.rmd'), output = file.path(DIR, 'model-nowcasts.r'))
	
	# Modify rmd to be a function
	read_lines('D:/OneDrive/__Projects/econforecasting/model-nowcasts.r') %>%
		paste0(., collapse = '\n') %>%
		paste0(
'
# This file has been auto-generated by model-nowcasts-backtest.rmd for backtesting -
# to modify original code with persistance, modify original code in model-nowcasts.rmd
nowcast = function(
	DIR = NULL,
	PACKAGE_DIR = NULL,
	DOC_DIR = NULL,
	INPUT_DIR = NULL,
	OUTPUT_DIR = NULL,
	RESET_ALL = FALSE,
	VINTAGE_DATE = NULL
	) {
',
.,
'return(ef)
}'
			) %>%
		write_lines(., file.path(DIR, 'model-nowcasts.r'))
	
	
	source(file.path(DIR, 'model-nowcasts.r'))
	
	nowcast <<- nowcast
})
```

# Run Backtest Dates
```{r}
local({
	
	runDates = seq(from = as.Date('2021-01-01'), to = Sys.Date(), by = '1 day')
		
	res =
		purrr::imap(runDates, function(.vdate, i) {
			nowcast(
				DIR = DIR,
				PACKAGE_DIR = PACKAGE_DIR,
				DOC_DIR = if (i == length(runDates)) DOC_DIR else NULL, # No create documentation
				INPUT_DIR = INPUT_DIR,
				OUTPUT_DIR = OUTPUT_DIR,
				RESET_ALL = FALSE,
				VINTAGE_DATE = .vdate
				)
			})
	
	runDates <<- runDates
})
```

# Aggregate
```{r}

	res =
		list.files(path = OUTPUT_DIR, pattern = 'nowcast.rds', full.names = TRUE) %>%
		purrr::map(., function(rds) invisible(readRDS(rds)))



	res %>%
		purrr::imap_dfr(., function(obj, i)
			obj$ef$ncpred$q$d1 %>%
				dplyr::select(., date, gdp) %>% 
				tidyr::pivot_longer(., -date, names_to = 'varname') %>%
				dplyr::mutate(., vdate = runDates[[i]])
			) %>%
		na.omit(.) %>%
		ggplot(.) +
		geom_line(aes(x = vdate, y = value, group = as.factor(date), color = as.factor(date)))

```











